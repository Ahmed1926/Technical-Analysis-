//@version=6
indicator("FVG + IFVG Gap (ULTRA) by Aditya Neje", overlay=true, max_boxes_count=500, max_lines_count=500)

// === Inputs ===
fvgLookback = input.int(200, "Lookback Candles", minval=1, maxval=500)
maxDrawingDistance = input.int(400, "Max Drawing Distance (bars back)", minval=50, maxval=500)
boxLength = input.int(10, "Box Length", minval=1)
boxWidth = input.int(1, "Box Border Width", minval=1, maxval=5)
showGaps = input.string("Both", "Show Gaps", options=["FVG Only", "IFVG Only", "Both"])

// === Inputs for 50% Line Marker ===
show50Line = input.bool(true, "Show 50% Line")
gap50LineWidth = input.int(1,"50% Line Width", minval=1, maxval=5)
gap50LineStyleOpt = input.string("Solid", "50% Line Style", options=["Solid", "Dotted", "Dashed"])
gap50LineStyle = gap50LineStyleOpt == "Solid" ? line.style_solid : gap50LineStyleOpt == "Dashed" ? line.style_dashed : line.style_dotted

// === Color Settings ===
bullFVGBorderColor = input.color(color.rgb(76, 175, 79, 100), "Bullish FVG Border", group="Style", inline="bull_fvg")
bullFVGBGColor = input.color(color.new(#0066CC, 90), "Background", group="Style", inline="bull_fvg")
bearFVGBorderColor = input.color(color.rgb(255, 82, 82, 100), "Bearish FVG Border", group="Style", inline="bear_fvg")
bearFVGBGColor = input.color(color.new(#0066CC, 90), "Background", group="Style", inline="bear_fvg")
bullIFVGBorderColor = input.color(color.rgb(0, 0, 0, 100), "Bullish IFVG Border", group="Style", inline="bull_ifvg")
bullIFVGBGColor = input.color(color.new(#0066CC, 90), "Background", group="Style", inline="bull_ifvg")
bearIFVGBorderColor = input.color(color.rgb(0, 0, 0, 100), "Bearish IFVG Border", group="Style", inline="bear_ifvg")
bearIFVGBGColor = input.color(color.new(#0066CC, 90), "Background", group="Style", inline="bear_ifvg")

// === User Defined Type for Gap ===
type Gap
    float high
    float low
    bool isBullish
    bool isIFVG
    box gapBox
    line gap50Line
    int createdBar
    bool hasVisuals  // Track if visuals are currently drawn

// === Array to store Gap objects ===
var array<Gap> gaps = array.new<Gap>()

// === Define Bullish/Bearish FVG ===
isBullishFVG = low > high[2]
bullFVGHigh = low
bullFVGLow = high[2]

isBearishFVG = high < low[2]
bearFVGHigh = low[2]
bearFVGLow = high

// === Helper function to create gap visuals ===
create_gap_visuals(gap) =>
    if bar_index - gap.createdBar <= maxDrawingDistance
        gapMid = (gap.high + gap.low) / 2

        // Set border and background colors
        borderColor = gap.isIFVG ? (gap.isBullish ? bullIFVGBorderColor : bearIFVGBorderColor) : (gap.isBullish ? bullFVGBorderColor : bearFVGBorderColor)
        bgColor = gap.isBullish ? bullFVGBGColor : bearFVGBGColor
        if gap.isIFVG
            bgColor := gap.isBullish ? bullIFVGBGColor : bearIFVGBGColor
        else if showGaps == "IFVG Only"
            bgColor := color.new(bgColor, 100)


        // Create box
        gap.gapBox := box.new(left=gap.createdBar, right=gap.createdBar+boxLength, top=gap.high, bottom=gap.low, border_color=borderColor, bgcolor=bgColor, border_width=boxWidth, xloc=xloc.bar_index)

        // Create 50% line if enabled
        if show50Line
            gap.gap50Line := line.new(x1=gap.createdBar, y1=gapMid, x2=gap.createdBar+boxLength, y2=gapMid, color=color.gray, width=gap50LineWidth, style=gap50LineStyle, xloc=xloc.bar_index)

        gap.hasVisuals := true
    else
        gap.hasVisuals := false

// === Helper function to delete gap visuals ===
delete_gap_visuals(gap) =>
    if gap.hasVisuals
        box.delete(gap.gapBox)
        if not na(gap.gap50Line)
            line.delete(gap.gap50Line)
        gap.hasVisuals := false

// === Create new FVG Gap objects ===
if isBullishFVG and (showGaps == "FVG Only" or showGaps == "Both" or showGaps == "IFVG Only")
    newGap = Gap.new(high = bullFVGHigh, low = bullFVGLow, isBullish = true, isIFVG = false, gapBox = box(na), gap50Line = line(na), createdBar = bar_index-2, hasVisuals = false)
    create_gap_visuals(newGap)
    array.unshift(gaps, newGap)

if isBearishFVG and (showGaps == "FVG Only" or showGaps == "Both" or showGaps == "IFVG Only")
    newGap = Gap.new(high = bearFVGHigh, low = bearFVGLow, isBullish = false, isIFVG = false, gapBox = box(na), gap50Line = line(na), createdBar = bar_index-2, hasVisuals = false)
    create_gap_visuals(newGap)
    array.unshift(gaps, newGap)

// === Process existing gaps for invalidation ===
if array.size(gaps) > 0
    for i = array.size(gaps) - 1 to 0
        gap = array.get(gaps, i)

        if not gap.isIFVG
            // FVG invalidation - convert to opposite IFVG at same timestamp
            if gap.isBullish
                if close < gap.low
                    delete_gap_visuals(gap)
                    if showGaps == "IFVG Only" or showGaps == "Both"
                        newIFVG = Gap.new(high = gap.high, low = gap.low, isBullish = false, isIFVG = true, gapBox = box(na), gap50Line = line(na), createdBar = gap.createdBar, hasVisuals = false)
                        create_gap_visuals(newIFVG)
                        array.set(gaps, i, newIFVG)
                    else
                        array.remove(gaps, i)
            else
                if close > gap.high
                    delete_gap_visuals(gap)
                    if showGaps == "IFVG Only" or showGaps == "Both"
                        newIFVG = Gap.new(high = gap.high, low = gap.low, isBullish = true, isIFVG = true, gapBox = box(na), gap50Line = line(na), createdBar = gap.createdBar, hasVisuals = false)
                        create_gap_visuals(newIFVG)
                        array.set(gaps, i, newIFVG)
                    else
                        array.remove(gaps, i)
        else
            // IFVG invalidation
            if gap.isBullish
                if close < gap.low
                    delete_gap_visuals(gap)
                    array.remove(gaps, i)
            else
                if close > gap.high
                    delete_gap_visuals(gap)
                    array.remove(gaps, i)

// === Hide or Remove All 50% Lines If Setting Turned Off ===
if not show50Line and array.size(gaps) > 0
    for i = 0 to array.size(gaps) - 1
        gap = array.get(gaps, i)
        if gap.hasVisuals and not na(gap.gap50Line)
            line.delete(gap.gap50Line)
            gap.gap50Line := line(na)

// === Update visuals for gaps that are now within drawing distance ===
if array.size(gaps) > 0
    for i = 0 to array.size(gaps) - 1
        gap = array.get(gaps, i)
        if not gap.hasVisuals and bar_index - gap.createdBar <= maxDrawingDistance
            create_gap_visuals(gap)

// === Trim array to limit lookback ===
if array.size(gaps) > fvgLookback
    oldestGap = array.pop(gaps)
    if oldestGap.hasVisuals
        box.delete(oldestGap.gapBox)
        if not na(oldestGap.gap50Line)
            line.delete(oldestGap.gap50Line)

My note for preferred settings: Background colors all should be dark blue with 10% opacity, 50% line style should be solid. 
