//@version=6
// Combined ICT Liquidity & Sessions Indicator
// Optimized for white background, mobile-friendly
// Includes: BSL/SSL, EQH/EQL, Liquidity Sweeps, Weekly/Daily Bias, Power of 3,
// DOL, Trading Sessions, Premium/Discount, Rejection Blocks, IPDA Deviations, S&D Profile
indicator('ICT Liquidity & Sessions [Combined]', overlay=true, max_bars_back=5000, max_boxes_count=500, max_labels_count=500, max_lines_count=500)

// ===================== GLOBAL SETTINGS =====================
var GROUP_GLOBAL = 'Global Settings'
showBSL_SSL = input.bool(true, 'Show Buy/Sell Side Liquidity', group=GROUP_GLOBAL)
showEQH_EQL = input.bool(true, 'Show Equal Highs/Lows', group=GROUP_GLOBAL)
showLiqSweeps = input.bool(true, 'Show Liquidity Sweeps', group=GROUP_GLOBAL)
showBias = input.bool(true, 'Show Weekly/Daily Bias', group=GROUP_GLOBAL)
showPO3 = input.bool(true, 'Show Power of 3', group=GROUP_GLOBAL)
showDOL = input.bool(true, 'Show Draw on Liquidity', group=GROUP_GLOBAL)
showSessions = input.bool(true, 'Show Trading Sessions', group=GROUP_GLOBAL)
showPD = input.bool(true, 'Show Premium/Discount Zones', group=GROUP_GLOBAL)
showRB = input.bool(true, 'Show Rejection Blocks', group=GROUP_GLOBAL)
showIPDA = input.bool(true, 'Show IPDA Deviations', group=GROUP_GLOBAL)
showSND = input.bool(false, 'Show S&D Profile', group=GROUP_GLOBAL)

// ===================== HIGHER TIMEFRAME VISIBILITY CONTROL =====================
// MTF Visibility Rules:
// 1W findings = visible on W & D only
// 1D findings = visible on D, 12H, 8H, 4H (1440 to 240 minutes)
// 4H findings = visible on 4H to 30M (240 to 30 minutes)
// 1H findings = visible on 1H to 5M (60 to 5 minutes)
// 5M findings = visible on 5M to 1M (5 to 1 minutes)
// 1M findings = visible on 5M & 1M only

canShowWeekly() =>
    tf = timeframe.period
    // Only W and D
    tf == 'W' or tf == 'D'

canShowDaily() =>
    tfInMinutes = timeframe.in_seconds() / 60
    // 1D down to 4H: 1440, 720, 480, 360, 240 (includes D, 12H, 8H, 4H)
    tfInMinutes <= 1440 and tfInMinutes >= 240

canShow4H() =>
    tfInMinutes = timeframe.in_seconds() / 60
    // 4H down to 30M: 240, 180, 120, 90, 60, 45, 30
    tfInMinutes <= 240 and tfInMinutes >= 30

canShow1H() =>
    tfInMinutes = timeframe.in_seconds() / 60
    // 1H down to 5M: 60, 45, 30, 15, 10, 5
    tfInMinutes <= 60 and tfInMinutes >= 5

canShow5M() =>
    tfInMinutes = timeframe.in_seconds() / 60
    // 5M down to 1M: 5, 3, 2, 1
    tfInMinutes <= 5 and tfInMinutes >= 1

canShow1M() =>
    tfInMinutes = timeframe.in_seconds() / 60
    // Only 5M and 1M
    tfInMinutes == 5 or tfInMinutes == 1

getCurrentTF() =>
    string result = timeframe.period
    if canShowWeekly()
        result := 'W'
    else if canShowDaily()
        result := 'D'
    else if canShow4H()
        result := '240'
    else if canShow1H()
        result := '60'
    else if canShow5M()
        result := '5'
    else if canShow1M()
        result := '1'
    result

shouldShowOnCurrentTF(string conceptTF) =>
    bool show = false
    if conceptTF == 'W'
        show := canShowWeekly()
    else if conceptTF == 'D'
        show := canShowDaily()
    else if conceptTF == '240'
        show := canShow4H()
    else if conceptTF == '60'
        show := canShow1H()
    else if conceptTF == '5'
        show := canShow5M()
    else if conceptTF == '1'
        show := canShow1M()
    else
        show := true
    show

// ===================== BSL & SSL (Buy/Sell Side Liquidity) =====================
var GROUP_BSL = 'Buy/Sell Side Liquidity'
bslTimeframe = input.timeframe('D', 'Timeframe for Analysis (Daily recommended)', group=GROUP_BSL)
length_bsl = input.int(20, title='Lookback Length', group=GROUP_BSL)
bslColor = input.color(color.green, 'BSL Color', group=GROUP_BSL)
sslColor = input.color(color.red, 'SSL Color', group=GROUP_BSL)

bslTF = bslTimeframe == '' ? getCurrentTF() : bslTimeframe
showBSLOnCurrentTF = shouldShowOnCurrentTF(bslTF)

highestHigh = ta.highest(high, length_bsl)
lowestLow = ta.lowest(low, length_bsl)
bslBreak = high == highestHigh
sslBreak = low == lowestLow

var float bslLevel = na
var float sslLevel = na
var line bslLine = na
var line sslLine = na
var label bslLabel = na
var label sslLabel = na

if showBSL_SSL and showBSLOnCurrentTF
    if bslBreak
        bslLevel := high
        line.delete(bslLine)
        label.delete(bslLabel)
        bslLine := line.new(bar_index, bslLevel, bar_index + 1, bslLevel, extend=extend.right, color=bslColor, width=2, style=line.style_solid)
        bslLabel := label.new(x=bar_index, y=bslLevel, text='BSL', style=label.style_label_down, color=color.new(color.white, 100), textcolor=bslColor, size=size.tiny)

    if sslBreak
        sslLevel := low
        line.delete(sslLine)
        label.delete(sslLabel)
        sslLine := line.new(bar_index, sslLevel, bar_index + 1, sslLevel, extend=extend.right, color=sslColor, width=2, style=line.style_solid)
        sslLabel := label.new(x=bar_index, y=sslLevel, text='SSL', style=label.style_label_up, color=color.new(color.white, 100), textcolor=sslColor, size=size.tiny)

// ===================== EQUAL HIGHS & LOWS =====================
var GROUP_EQL = 'Equal Highs/Lows'
eqlTimeframe = input.timeframe('240', 'Timeframe for Analysis (4H recommended)', group=GROUP_EQL)
precision_eql = input.int(2, step=1, minval=1, title='Precision', group=GROUP_EQL)
eqlHighColor = input.color(color.new(color.green, 0), 'Highs Color', group=GROUP_EQL)
eqlLowColor = input.color(color.new(color.red, 0), 'Lows Color', group=GROUP_EQL)

eqlTF = eqlTimeframe == '' ? getCurrentTF() : eqlTimeframe
showEQLOnCurrentTF = shouldShowOnCurrentTF(eqlTF)

max_eq = math.max(high, high[1])
min_eq = math.min(low, low[1])
top_eq = (math.abs(high - high[1]) / (max_eq - min_eq)) * 100
bottom_eq = (math.abs(low - low[1]) / (max_eq - min_eq)) * 100

top_v = ta.crossunder(top_eq, precision_eql)
bottom_v = ta.crossunder(bottom_eq, precision_eql)

if showEQH_EQL and showEQLOnCurrentTF
    if top_v
        line.new(bar_index[1], high[1], bar_index, high, color=eqlHighColor, style=line.style_solid, width=2)
        label.new(bar_index, high, 'EQH', style=label.style_label_down, color=color.new(color.white, 100), textcolor=color.green, size=size.tiny)
    if bottom_v
        line.new(bar_index[1], low[1], bar_index, low, color=eqlLowColor, style=line.style_solid, width=2)
        label.new(bar_index, low, 'EQL', style=label.style_label_up, color=color.new(color.white, 100), textcolor=color.red, size=size.tiny)

// ===================== LIQUIDITY SWEEPS =====================
var GROUP_SWEEP = 'Liquidity Sweeps'
sweepTimeframe = input.timeframe('60', 'Timeframe for Analysis (1H recommended)', group=GROUP_SWEEP)
pivotLength = input.int(14, title='Pivot Length', group=GROUP_SWEEP)
sweepColor = input.color(color.yellow, 'Sweep Color', group=GROUP_SWEEP)

sweepTF = sweepTimeframe == '' ? getCurrentTF() : sweepTimeframe
showSweepOnCurrentTF = shouldShowOnCurrentTF(sweepTF)

ph_sweep = ta.pivothigh(pivotLength, pivotLength)
pl_sweep = ta.pivotlow(pivotLength, pivotLength)

var float swingHigh_sweep = na
var float swingLow_sweep = na
var bool sweptHigh = false
var bool sweptLow = false

if bool(ph_sweep)
    swingHigh_sweep := high[pivotLength]
    sweptHigh := false

if bool(pl_sweep)
    swingLow_sweep := low[pivotLength]
    sweptLow := false

bearishSweepCondition = high > swingHigh_sweep and close < swingHigh_sweep
bullishSweepCondition = low < swingLow_sweep and close > swingLow_sweep

if showLiqSweeps and showSweepOnCurrentTF and not sweptHigh and not na(swingHigh_sweep) and bearishSweepCondition
    label.new(bar_index, high, 'SWEEP', color=sweepColor, style=label.style_label_down, textcolor=color.black, size=size.tiny)
    sweptHigh := true

if showLiqSweeps and showSweepOnCurrentTF and not sweptLow and not na(swingLow_sweep) and bullishSweepCondition
    label.new(bar_index, low, 'SWEEP', color=sweepColor, style=label.style_label_up, textcolor=color.black, size=size.tiny)
    sweptLow := true

// ===================== WEEKLY & DAILY BIAS =====================
var GROUP_BIAS = 'Weekly & Daily Bias'
d_bias = input.bool(true, 'Daily Bias', group=GROUP_BIAS)
w_bias = input.bool(false, 'Weekly Bias', group=GROUP_BIAS)
bullBiasColor = input.color(color.new(color.green, 0), 'Bull Bias', group=GROUP_BIAS)
bearBiasColor = input.color(color.new(color.red, 0), 'Bear Bias', group=GROUP_BIAS)

// Bias automatically respects timeframe (daily for daily bias, weekly for weekly bias)
type info_bias
    float ph
    float pl
    float ch
    float cl
    float co
    bool p_up
    int bias = 0

var d_info = info_bias.new()
var w_info = info_bias.new()

new_day = timeframe.change('D')
new_week = timeframe.change('W')

if showBias and d_bias and new_day and canShowDaily()
    if not na(d_info.ch)
        if close[1] >= d_info.co
            d_info.p_up := true
        else
            d_info.p_up := false
        d_info.ph := d_info.ch
        d_info.pl := d_info.cl
        d_info.ch := high
        d_info.cl := low
        d_info.co := open

if na(d_info.ch)
    d_info.ch := high
    d_info.cl := low
else
    d_info.ch := math.max(high, d_info.ch)
    d_info.cl := math.min(low, d_info.cl)

plotshape(showBias and d_bias and canShowDaily(), 'Daily Bias', style=shape.square, size=size.tiny, location=location.top, color=d_info.bias == 1 ? bullBiasColor : d_info.bias == -1 ? bearBiasColor : na)

// ===================== POWER OF 3 =====================
var GROUP_PO3 = 'Power of 3'
show_Accumulation = input(true, 'Accumulation', group=GROUP_PO3)
Accumulation_ses = input.session('1900-0100', '', group=GROUP_PO3)
Accumulation_color = input.color(color.new(color.blue, 90), 'Color', group=GROUP_PO3)
show_Manipulation = input(true, 'Manipulation', group=GROUP_PO3)
Manipulation_ses = input.session('0100-0700', '', group=GROUP_PO3)
Manipulation_color = input.color(color.new(#F0B884, 90), 'Color', group=GROUP_PO3)
show_Distribution = input(true, 'Distribution', group=GROUP_PO3)
Distribution_ses = input.session('0700-1300', '', group=GROUP_PO3)
Distribution_color = input.color(color.new(#0CC1C0, 90), 'Color', group=GROUP_PO3)

// Power of 3 shows on intraday timeframes (1H and below)
On_Accumulation = math.sign(nz(time(timeframe.period, Accumulation_ses, 'America/New_York')))
On_Manipulation = math.sign(nz(time(timeframe.period, Manipulation_ses, 'America/New_York')))
On_Distribution = math.sign(nz(time(timeframe.period, Distribution_ses, 'America/New_York')))

LowHighDetector(On, Color, Text) =>
    var int Bar = 0
    var float High = 0.0
    var float Low = 0.0
    var box BoX = na
    var label LabeL = na
    if On[1] == 0 and On == 1
        Bar := bar_index
        High := high
        Low := low
    else
        if On[1] == 1 or On == 1
            High := math.max(high, High)
            Low := math.min(low, Low)
    if On > On[1] and str.tonumber(timeframe.period) <= 60
        BoX := box.new(bar_index, High, bar_index, Low, bgcolor=Color, border_color=color.new(color.gray, 50), border_style=line.style_dotted)
        LabeL := label.new(int(math.avg(Bar, bar_index)), High, text=Text, xloc=xloc.bar_index, yloc=yloc.price, size=size.tiny, style=label.style_label_down, textcolor=color.black, color=color.new(color.white, 100))
    if On[1] == 1 or On == 1
        if not na(BoX)
            box.set_top(BoX, High)
            box.set_bottom(BoX, Low)
            box.set_right(BoX, bar_index)
        if not na(LabeL)
            label.set_x(LabeL, math.round(math.avg(Bar, bar_index)))
            label.set_y(LabeL, High)

if showPO3 and show_Accumulation and canShow1H()
    LowHighDetector(On_Accumulation, Accumulation_color, 'ACC')

if showPO3 and show_Manipulation and canShow1H()
    LowHighDetector(On_Manipulation, Manipulation_color, 'MAN')

if showPO3 and show_Distribution and canShow1H()
    LowHighDetector(On_Distribution, Distribution_color, 'DIST')

// ===================== DRAW ON LIQUIDITY =====================
var GROUP_DOL = 'Draw on Liquidity'
dolTimeframe = input.timeframe('240', 'Timeframe for Analysis (4H recommended)', group=GROUP_DOL)
pivotLength_dol = input.int(5, 'Pivot Length', minval=1, maxval=50, group=GROUP_DOL)
volMultiplier = input.float(2.0, 'Volume Threshold', minval=0.1, step=0.1, group=GROUP_DOL)
volPeriod = input.int(20, 'Volume MA Period', minval=1, group=GROUP_DOL)
highLiqColor = input.color(color.new(#2962FF, 0), 'High Liquidity', group=GROUP_DOL)
lowLiqColor = input.color(color.new(#FF2727, 0), 'Low Liquidity', group=GROUP_DOL)
lineWidth_dol = input.int(2, 'Line Width', minval=1, maxval=4, group=GROUP_DOL)

dolTF = dolTimeframe == '' ? getCurrentTF() : dolTimeframe
showDOLOnCurrentTF = shouldShowOnCurrentTF(dolTF)

pivotHigh_dol = ta.pivothigh(high, pivotLength_dol, pivotLength_dol)
pivotLow_dol = ta.pivotlow(low, pivotLength_dol, pivotLength_dol)
averageVolume = ta.sma(volume, volPeriod)
isHighVolume_dol = volume > volMultiplier * averageVolume

isValidHigh_dol = not na(pivotHigh_dol) and isHighVolume_dol
isValidLow_dol = not na(pivotLow_dol) and isHighVolume_dol

var array<line> highLiquidityLines = array.new<line>(0)
var array<line> lowLiquidityLines = array.new<line>(0)
var array<bool> highLineHit = array.new<bool>(0)
var array<bool> lowLineHit = array.new<bool>(0)

if showDOL and showDOLOnCurrentTF and isValidHigh_dol
    newHighLine = line.new(bar_index - pivotLength_dol, pivotHigh_dol, bar_index, pivotHigh_dol, color=highLiqColor, width=lineWidth_dol, extend=extend.right)
    array.push(highLiquidityLines, newHighLine)
    array.push(highLineHit, false)
    label.new(bar_index, pivotHigh_dol, 'DOL', style=label.style_label_down, color=color.new(color.white, 100), textcolor=highLiqColor, size=size.tiny)

if showDOL and showDOLOnCurrentTF and isValidLow_dol
    newLowLine = line.new(bar_index - pivotLength_dol, pivotLow_dol, bar_index, pivotLow_dol, color=lowLiqColor, width=lineWidth_dol, extend=extend.right)
    array.push(lowLiquidityLines, newLowLine)
    array.push(lowLineHit, false)
    label.new(bar_index, pivotLow_dol, 'DOL', style=label.style_label_up, color=color.new(color.white, 100), textcolor=lowLiqColor, size=size.tiny)

// Update DOL lines
if showDOL and array.size(highLiquidityLines) > 0
    for i = 0 to array.size(highLiquidityLines) - 1
        currentLine = array.get(highLiquidityLines, i)
        if not array.get(highLineHit, i)
            if close >= line.get_y1(currentLine)
                array.set(highLineHit, i, true)
                line.delete(currentLine)
            else
                line.set_x2(currentLine, bar_index)

if showDOL and array.size(lowLiquidityLines) > 0
    for i = 0 to array.size(lowLiquidityLines) - 1
        currentLine = array.get(lowLiquidityLines, i)
        if not array.get(lowLineHit, i)
            if close <= line.get_y1(currentLine)
                array.set(lowLineHit, i, true)
                line.delete(currentLine)
            else
                line.set_x2(currentLine, bar_index)

// ===================== TRADING SESSIONS =====================
var GROUP_SESS = 'Trading Sessions'
show_asian = input.bool(true, 'Show Asian Session', group=GROUP_SESS)
show_london = input.bool(true, 'Show London Session', group=GROUP_SESS)
show_ny = input.bool(true, 'Show New York Session', group=GROUP_SESS)
asian_color = input.color(color.new(color.blue, 90), 'Asian', group=GROUP_SESS)
london_color = input.color(color.new(color.teal, 90), 'London', group=GROUP_SESS)
ny_color = input.color(color.new(color.black, 90), 'New York (Black)', group=GROUP_SESS)

// Sessions show on intraday timeframes
asian_session = time(timeframe.period, '2000-0300', 'America/New_York')
london_session = time(timeframe.period, '0300-0830', 'America/New_York')
ny_session = time(timeframe.period, '0830-1600', 'America/New_York')

bgcolor(showSessions and show_asian and not na(asian_session) and canShow1H() ? asian_color : na, title='Asian Session')
bgcolor(showSessions and show_london and not na(london_session) and canShow1H() ? london_color : na, title='London Session')
bgcolor(showSessions and show_ny and not na(ny_session) and canShow1H() ? ny_color : na, title='NY Session')

// ===================== PREMIUM/DISCOUNT ZONES =====================
var GROUP_PD = 'Premium/Discount Zones'
pdTimeframe = input.timeframe('D', 'Timeframe for Analysis (Daily recommended)', group=GROUP_PD)
pd_high = input.float(0.0, title='Range High (0 = disabled)', group=GROUP_PD)
pd_low = input.float(0.0, title='Range Low (0 = disabled)', group=GROUP_PD)
show_premium = input.bool(true, 'Show Premium Zone', group=GROUP_PD)
show_discount = input.bool(true, 'Show Discount Zone', group=GROUP_PD)
show_equilibrium = input.bool(true, 'Show Equilibrium', group=GROUP_PD)
premium_color = input.color(color.new(color.red, 0), 'Premium', group=GROUP_PD)
discount_color = input.color(color.new(color.green, 0), 'Discount', group=GROUP_PD)
eq_color = input.color(color.new(color.blue, 0), 'Equilibrium', group=GROUP_PD)

pdTF = pdTimeframe == '' ? getCurrentTF() : pdTimeframe
showPDOnCurrentTF = shouldShowOnCurrentTF(pdTF)

if showPD and showPDOnCurrentTF and timeframe.period == 'D' and pd_high != 0.0 and pd_low != 0.0
    midline = (pd_high + pd_low) / 2
    premium_start = pd_high - 0.25 * (pd_high - pd_low)
    discount_end = pd_high - 0.75 * (pd_high - pd_low)

    if show_premium
        line.new(bar_index, pd_high, bar_index + 1, pd_high, extend=extend.right, color=premium_color, width=2, style=line.style_solid)
        line.new(bar_index, premium_start, bar_index + 1, premium_start, extend=extend.right, color=premium_color, style=line.style_dotted)

    if show_discount
        line.new(bar_index, pd_low, bar_index + 1, pd_low, extend=extend.right, color=discount_color, width=2, style=line.style_solid)
        line.new(bar_index, discount_end, bar_index + 1, discount_end, extend=extend.right, color=discount_color, style=line.style_dotted)

    if show_equilibrium
        line.new(bar_index, midline, bar_index + 1, midline, extend=extend.right, color=eq_color, width=2, style=line.style_solid)

// ===================== REJECTION BLOCKS =====================
var GROUP_RB = 'Rejection Blocks'
rbTimeframe = input.timeframe('60', 'Timeframe for Analysis (1H recommended)', group=GROUP_RB)
showBullRB = input.bool(true, 'Show Bullish RB', group=GROUP_RB)
showBearRB = input.bool(true, 'Show Bearish RB', group=GROUP_RB)
rbBullColor = input.color(color.new(color.green, 85), 'Bullish RB', group=GROUP_RB)
rbBearColor = input.color(color.new(color.red, 85), 'Bearish RB', group=GROUP_RB)

rbTF = rbTimeframe == '' ? getCurrentTF() : rbTimeframe
showRBOnCurrentTF = shouldShowOnCurrentTF(rbTF)

isBullishRB = close[1] < open[1] and low[1] < low[2] and low[1] < low
isBearishRB = close[1] > open[1] and high[1] > high[2] and high[1] > high

if showRB and showRBOnCurrentTF and showBullRB and isBullishRB
    box.new(left=bar_index[1], top=high[1], right=bar_index, bottom=low[1], border_color=color.new(color.green, 100), bgcolor=rbBullColor)
    label.new(bar_index[1], low[1], 'RB+', style=label.style_label_up, color=color.new(color.white, 100), textcolor=color.green, size=size.tiny)

if showRB and showRBOnCurrentTF and showBearRB and isBearishRB
    box.new(left=bar_index[1], top=high[1], right=bar_index, bottom=low[1], border_color=color.new(color.red, 100), bgcolor=rbBearColor)
    label.new(bar_index[1], high[1], 'RB-', style=label.style_label_down, color=color.new(color.white, 100), textcolor=color.red, size=size.tiny)

// ===================== IPDA DEVIATIONS =====================
var GROUP_IPDA = 'IPDA Deviations'
ipdaTimeframe = input.timeframe('D', 'Timeframe for Analysis (Daily recommended)', group=GROUP_IPDA)
ipdaPivotLength = input.int(5, 'Pivot Length', minval=1, group=GROUP_IPDA)
showIPDALabels = input.bool(true, 'Show Labels', group=GROUP_IPDA)
ipdaLineColor = input.color(color.new(color.gray, 0), 'Line Color', group=GROUP_IPDA)

ipdaTF = ipdaTimeframe == '' ? getCurrentTF() : ipdaTimeframe
showIPDAOnCurrentTF = shouldShowOnCurrentTF(ipdaTF)

var line ipda_high_line = na
var line ipda_low_line = na
var line ipda_eq_line = na
var label ipda_high_label = na
var label ipda_low_label = na
var label ipda_eq_label = na

// Track swing highs and lows
pivotHigh_ipda = ta.pivothigh(high, ipdaPivotLength, ipdaPivotLength)
pivotLow_ipda = ta.pivotlow(low, ipdaPivotLength, ipdaPivotLength)

var float ipda_swing_high = na
var float ipda_swing_low = na

if showIPDA and showIPDAOnCurrentTF and timeframe.period == 'D' and not na(pivotHigh_ipda)
    ipda_swing_high := high[ipdaPivotLength]

if showIPDA and showIPDAOnCurrentTF and timeframe.period == 'D' and not na(pivotLow_ipda)
    ipda_swing_low := low[ipdaPivotLength]

// Draw IPDA deviation levels
if showIPDA and showIPDAOnCurrentTF and timeframe.period == 'D' and not na(ipda_swing_high) and not na(ipda_swing_low) and barstate.islast
    // Calculate equilibrium
    ipda_eq = (ipda_swing_high + ipda_swing_low) / 2
    ipda_range = ipda_swing_high - ipda_swing_low

    // Calculate deviation levels
    ipda_dev_1 = ipda_swing_high + (ipda_range * 0.5)
    ipda_dev_neg1 = ipda_swing_low - (ipda_range * 0.5)
    ipda_dev_2 = ipda_swing_high + (ipda_range * 1.0)
    ipda_dev_neg2 = ipda_swing_low - (ipda_range * 1.0)

    // Delete old lines
    line.delete(ipda_high_line)
    line.delete(ipda_low_line)
    line.delete(ipda_eq_line)
    label.delete(ipda_high_label)
    label.delete(ipda_low_label)
    label.delete(ipda_eq_label)

    // Draw lines
    ipda_high_line := line.new(bar_index - 50, ipda_swing_high, bar_index + 20, ipda_swing_high, extend=extend.right, color=ipdaLineColor, width=2)
    ipda_low_line := line.new(bar_index - 50, ipda_swing_low, bar_index + 20, ipda_swing_low, extend=extend.right, color=ipdaLineColor, width=2)
    ipda_eq_line := line.new(bar_index - 50, ipda_eq, bar_index + 20, ipda_eq, extend=extend.right, color=ipdaLineColor, width=1, style=line.style_dashed)

    // Draw deviation lines
    line.new(bar_index - 50, ipda_dev_1, bar_index + 20, ipda_dev_1, extend=extend.right, color=color.new(ipdaLineColor, 50), width=1, style=line.style_dotted)
    line.new(bar_index - 50, ipda_dev_neg1, bar_index + 20, ipda_dev_neg1, extend=extend.right, color=color.new(ipdaLineColor, 50), width=1, style=line.style_dotted)
    line.new(bar_index - 50, ipda_dev_2, bar_index + 20, ipda_dev_2, extend=extend.right, color=color.new(ipdaLineColor, 70), width=1, style=line.style_dotted)
    line.new(bar_index - 50, ipda_dev_neg2, bar_index + 20, ipda_dev_neg2, extend=extend.right, color=color.new(ipdaLineColor, 70), width=1, style=line.style_dotted)

    if showIPDALabels
        ipda_high_label := label.new(bar_index, ipda_swing_high, '1', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        ipda_low_label := label.new(bar_index, ipda_swing_low, '1', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        ipda_eq_label := label.new(bar_index, ipda_eq, '0', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        label.new(bar_index, ipda_dev_1, '1.5', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        label.new(bar_index, ipda_dev_neg1, '-1.5', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        label.new(bar_index, ipda_dev_2, '2', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)
        label.new(bar_index, ipda_dev_neg2, '-2', style=label.style_label_left, color=color.new(color.white, 100), textcolor=ipdaLineColor, size=size.tiny)

// ===================== S&D PROFILE =====================
var GROUP_SND = 'Seek & Destroy Profile'
sndTimeframe = input.timeframe('D', 'Timeframe for Analysis (Daily recommended)', group=GROUP_SND)
showSNDLabels = input.bool(true, 'Show Labels', group=GROUP_SND)
sndColor = input.color(color.new(color.purple, 80), 'S&D Color', group=GROUP_SND)

sndTF = sndTimeframe == '' ? getCurrentTF() : sndTimeframe
showSNDOnCurrentTF = shouldShowOnCurrentTF(sndTF)

// S&D Profile tracks when London takes both sides of Asian range
var float asian_high = na
var float asian_low = na
var float london_high = na
var float london_low = na
var bool snd_setup = false

// Track Asian session highs/lows
asian_session_active = not na(time(timeframe.period, '2000-0300', 'America/New_York'))
london_session_active = not na(time(timeframe.period, '0300-0830', 'America/New_York'))

if showSND and showSNDOnCurrentTF and asian_session_active
    if na(asian_high) or na(asian_low)
        asian_high := high
        asian_low := low
    else
        asian_high := math.max(high, asian_high)
        asian_low := math.min(low, asian_low)

// Reset for new day
if showSND and showSNDOnCurrentTF and timeframe.change('D')
    asian_high := na
    asian_low := na
    london_high := na
    london_low := na
    snd_setup := false

// Track London session
if showSND and showSNDOnCurrentTF and london_session_active and not na(asian_high) and not na(asian_low)
    if na(london_high) or na(london_low)
        london_high := high
        london_low := low
    else
        london_high := math.max(high, london_high)
        london_low := math.min(low, london_low)

    // Check if London took both sides of Asian range
    if london_high > asian_high and london_low < asian_low and not snd_setup
        snd_setup := true
        if showSNDLabels
            label.new(bar_index, high, 'S&D', color=sndColor, textcolor=color.white, style=label.style_label_down, size=size.tiny, tooltip='Seek & Destroy setup detected')
